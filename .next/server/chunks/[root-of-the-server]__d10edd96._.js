module.exports = [
"[project]/Downloads/mrpii 2/.next-internal/server/app/api/scada/machine-details/route/actions.js [app-rsc] (server actions loader, ecmascript)", ((__turbopack_context__, module, exports) => {

}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/action-async-storage.external.js [external] (next/dist/server/app-render/action-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/action-async-storage.external.js", () => require("next/dist/server/app-render/action-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/events [external] (events, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/crypto [external] (crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}),
"[externals]/os [external] (os, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}),
"[externals]/tls [external] (tls, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}),
"[externals]/net [external] (net, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}),
"[externals]/dns [external] (dns, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("dns", () => require("dns"));

module.exports = mod;
}),
"[externals]/constants [external] (constants, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("constants", () => require("constants"));

module.exports = mod;
}),
"[externals]/node:os [external] (node:os, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:os", () => require("node:os"));

module.exports = mod;
}),
"[externals]/node:util [external] (node:util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:util", () => require("node:util"));

module.exports = mod;
}),
"[externals]/node:process [external] (node:process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:process", () => require("node:process"));

module.exports = mod;
}),
"[externals]/node:crypto [external] (node:crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:crypto", () => require("node:crypto"));

module.exports = mod;
}),
"[externals]/node:http [external] (node:http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:http", () => require("node:http"));

module.exports = mod;
}),
"[externals]/node:https [external] (node:https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:https", () => require("node:https"));

module.exports = mod;
}),
"[externals]/node:zlib [external] (node:zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:zlib", () => require("node:zlib"));

module.exports = mod;
}),
"[externals]/node:stream [external] (node:stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:stream", () => require("node:stream"));

module.exports = mod;
}),
"[externals]/assert [external] (assert, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("assert", () => require("assert"));

module.exports = mod;
}),
"[externals]/tty [external] (tty, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("tty", () => require("tty"));

module.exports = mod;
}),
"[externals]/util [external] (util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/buffer [external] (buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}),
"[externals]/fs [external] (fs, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}),
"[externals]/path [external] (path, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}),
"[externals]/node:fs/promises [external] (node:fs/promises, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:fs/promises", () => require("node:fs/promises"));

module.exports = mod;
}),
"[externals]/child_process [external] (child_process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("child_process", () => require("child_process"));

module.exports = mod;
}),
"[externals]/node:child_process [external] (node:child_process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:child_process", () => require("node:child_process"));

module.exports = mod;
}),
"[externals]/dgram [external] (dgram, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("dgram", () => require("dgram"));

module.exports = mod;
}),
"[externals]/node:url [external] (node:url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:url", () => require("node:url"));

module.exports = mod;
}),
"[externals]/string_decoder [external] (string_decoder, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("string_decoder", () => require("string_decoder"));

module.exports = mod;
}),
"[project]/Downloads/mrpii 2/lib/database/connection.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "closeDbConnection",
    ()=>closeDbConnection,
    "executeQuery",
    ()=>executeQuery,
    "getDbConnection",
    ()=>getDbConnection,
    "testConnections",
    ()=>testConnections
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$tedious$2f$lib$2f$tedious$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Downloads/mrpii 2/node_modules/tedious/lib/tedious.js [app-route] (ecmascript)");
;
// Configuraciones para múltiples bases de datos como en el PHP original
const baseConfig = {
    server: process.env.DB_SERVER || '10.0.0.45',
    authentication: {
        type: 'default',
        options: {
            userName: process.env.DB_USER || 'sa',
            password: process.env.DB_PASSWORD || 'Mapexdd2017'
        }
    },
    options: {
        port: parseInt(process.env.DB_PORT || '1433'),
        encrypt: false,
        trustServerCertificate: true,
        connectTimeout: 30000,
        requestTimeout: 30000,
        enableArithAbort: true
    }
};
// Configuraciones específicas para cada base de datos
const mapexConfig = {
    ...baseConfig,
    options: {
        ...baseConfig.options,
        database: process.env.DB_NAME || 'mapexbp_Test'
    }
};
const sageConfig = {
    ...baseConfig,
    authentication: {
        type: 'default',
        options: {
            userName: 'sa',
            password: 'admin000'
        }
    },
    options: {
        ...baseConfig.options,
        database: 'SAGE'
    }
};
const whalesConfig = {
    ...baseConfig,
    authentication: {
        type: 'default',
        options: {
            userName: 'sa',
            password: '87cc88bb89.'
        }
    },
    options: {
        ...baseConfig.options,
        database: 'WHALES'
    }
};
async function getDbConnection(database = 'mapex') {
    let config;
    switch(database){
        case 'mapex':
            config = mapexConfig;
            break;
        case 'sage':
            config = sageConfig;
            break;
        case 'whales':
            config = whalesConfig;
            break;
        default:
            config = mapexConfig;
    }
    const connection = new __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$tedious$2f$lib$2f$tedious$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Connection"](config);
    return new Promise((resolve, reject)=>{
        connection.on('connect', (err)=>{
            if (err) {
                console.error(`❌ Erro ao conectar à base ${database.toUpperCase()}:`, err);
                reject(err);
            } else {
                console.log(`✅ Nova conexão criada para ${database.toUpperCase()}`);
                resolve(connection);
            }
        });
        connection.on('error', (err)=>{
            console.error(`❌ Erro na conexão ${database.toUpperCase()}:`, err);
            reject(err);
        });
        // Não definir on('end') aqui pois vamos fechar manualmente
        connection.connect();
    });
}
async function executeQuery(sql, parameters, database = 'mapex') {
    const conn = await getDbConnection(database);
    return new Promise((resolve, reject)=>{
        const results = [];
        const request = new __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$tedious$2f$lib$2f$tedious$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Request"](sql, (err)=>{
            // Sempre fechar a conexão após completar a query
            try {
                conn.close();
            } catch (closeErr) {
                console.warn('⚠️ Erro ao fechar conexão:', closeErr);
            }
            if (err) {
                console.error(`❌ Erro na query ${database.toUpperCase()}:`, err);
                console.error('SQL:', sql.substring(0, 200) + '...');
                reject(err);
            } else {
                resolve(results);
            }
        });
        // Adicionar parâmetros se fornecidos
        if (parameters) {
            Object.entries(parameters).forEach(([key, value])=>{
                let type = __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$tedious$2f$lib$2f$tedious$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["TYPES"].NVarChar;
                if (typeof value === 'number') {
                    type = Number.isInteger(value) ? __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$tedious$2f$lib$2f$tedious$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["TYPES"].Int : __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$tedious$2f$lib$2f$tedious$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["TYPES"].Float;
                } else if (typeof value === 'boolean') {
                    type = __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$tedious$2f$lib$2f$tedious$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["TYPES"].Bit;
                } else if (value instanceof Date) {
                    type = __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$tedious$2f$lib$2f$tedious$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["TYPES"].DateTime;
                }
                request.addParameter(key, type, value);
            });
        }
        request.on('row', (columns)=>{
            const row = {};
            columns.forEach((column)=>{
                row[column.metadata.colName] = column.value;
            });
            results.push(row);
        });
        try {
            conn.execSql(request);
        } catch (execErr) {
            // Se houver erro na execução, fechar conexão e rejeitar
            try {
                conn.close();
            } catch (closeErr) {
                console.warn('⚠️ Erro ao fechar conexão após falha:', closeErr);
            }
            reject(execErr);
        }
    });
}
async function closeDbConnection(database) {
    // Como agora criamos uma nova conexão para cada query e fechamos automaticamente,
    // esta função é mantida por compatibilidade mas não faz mais sentido
    console.log('ℹ️ Conexões agora são gerenciadas automaticamente por query');
}
async function testConnections() {
    const results = {};
    for (const db of [
        'mapex',
        'sage',
        'whales'
    ]){
        try {
            await executeQuery('SELECT 1 as test', undefined, db);
            results[db] = true;
            console.log(`✅ Teste de conectividade ${db.toUpperCase()}: OK`);
        } catch (error) {
            results[db] = false;
            console.error(`❌ Teste de conectividade ${db.toUpperCase()}: FALHOU`, error);
        }
    }
    return results;
}
}),
"[project]/Downloads/mrpii 2/lib/oee/calculations.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "analizarParetoCausas",
    ()=>analizarParetoCausas,
    "calcularOEE",
    ()=>calcularOEE,
    "calcularOEEPonderado",
    ()=>calcularOEEPonderado,
    "calculateOEEForOF",
    ()=>calculateOEEForOF,
    "calculateOEEForTurno",
    ()=>calculateOEEForTurno,
    "calculateProgress",
    ()=>calculateProgress,
    "calculateRemainingTime",
    ()=>calculateRemainingTime,
    "generarAlertas",
    ()=>generarAlertas,
    "getProductionDataForOF",
    ()=>getProductionDataForOF
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Downloads/mrpii 2/lib/database/connection.ts [app-route] (ecmascript)");
;
async function calculateOEEForOF(machineCode, codOF, daysBack = 10) {
    try {
        // Simular a função F_his_ct() do MAPEX - calcular OEE baseado em dados históricos
        const sql = `
      SELECT
        -- Disponibilidad: tiempo disponible vs tiempo total
        CASE
          WHEN SUM(CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT)) > 0 THEN
            ROUND(
              (SUM(CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT)) -
               ISNULL(SUM(CASE WHEN hp.id_actividad = 3 THEN CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT) ELSE 0 END), 0)
              ) * 100.0 /
              SUM(CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT)), 2
            )
          ELSE 0
        END as disponibilidad,

        -- Rendimiento: unidades producidas vs velocidad nominal
        CASE
          WHEN cm.Rt_Rendimientonominal1 > 0 AND SUM(CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT)) > 0 THEN
            ROUND(
              (SUM(hp.unidades_ok + hp.unidades_nok) * 3600.0) /
              (cm.Rt_Rendimientonominal1 * (SUM(CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT)) / 3600.0)), 2
            )
          ELSE 0
        END as rendimiento,

        -- Calidad: unidades OK vs total producidas
        CASE
          WHEN SUM(hp.unidades_ok + hp.unidades_nok) > 0 THEN
            ROUND((SUM(hp.unidades_ok) * 100.0) / SUM(hp.unidades_ok + hp.unidades_nok), 2)
          ELSE 0
        END as calidad

      FROM cfg_maquina cm
      LEFT JOIN his_fase hf ON cm.rt_id_his_fase = hf.id_his_fase
      LEFT JOIN his_prod hp ON hf.id_his_fase = hp.id_his_fase
      WHERE cm.Cod_maquina = '${machineCode}'
      AND cm.Rt_Cod_of = '${codOF}'
      AND hp.fecha_fin >= DATEADD(DAY, -${daysBack}, GETDATE())
      AND hp.id_actividad = 2 -- Producción
      GROUP BY cm.Rt_Rendimientonominal1 -- Agrupar para agregar correctamente
    `;
        const result = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql, undefined, 'mapex');
        if (result.length === 0 || !result[0]) {
            return null;
        }
        const row = result[0];
        const disponibilidad = Math.max(0, Math.min(100, row.disponibilidad || 0));
        const rendimiento = Math.max(0, Math.min(100, row.rendimiento || 0));
        const calidad = Math.max(0, Math.min(100, row.calidad || 0));
        // OEE = Disponibilidad × Rendimiento × Calidad
        const oee = Math.round(disponibilidad * rendimiento * calidad / 10000);
        return {
            oee,
            rendimiento,
            disponibilidad,
            calidad
        };
    } catch (error) {
        console.error('❌ Erro ao calcular OEE para OF:', error);
        return null;
    }
}
async function calculateOEEForTurno(machineCode, diaProductivo) {
    try {
        const sql = `
      SELECT
        -- Disponibilidad del turno
        CASE
          WHEN SUM(CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT)) > 0 THEN
            ROUND(
              (SUM(CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT)) -
               ISNULL(SUM(CASE WHEN hp.id_actividad = 3 THEN CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT) ELSE 0 END), 0)
              ) * 100.0 /
              SUM(CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT)), 2
            )
          ELSE 0
        END as disponibilidad,

        -- Rendimiento del turno
        CASE
          WHEN cm.Rt_Rendimientonominal1 > 0 AND SUM(CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT)) > 0 THEN
            ROUND(
              (SUM(hp.unidades_ok + hp.unidades_nok) * 3600.0) /
              (cm.Rt_Rendimientonominal1 * (SUM(CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT)) / 3600.0)), 2
            )
          ELSE 0
        END as rendimiento,

        -- Calidad del turno
        CASE
          WHEN SUM(hp.unidades_ok + hp.unidades_nok) > 0 THEN
            ROUND((SUM(hp.unidades_ok) * 100.0) / SUM(hp.unidades_ok + hp.unidades_nok), 2)
          ELSE 0
        END as calidad

      FROM cfg_maquina cm
      LEFT JOIN his_fase hf ON cm.rt_id_his_fase = hf.id_his_fase
      LEFT JOIN his_prod hp ON hf.id_his_fase = hp.id_his_fase
      WHERE cm.Cod_maquina = '${machineCode}'
      AND CONVERT(VARCHAR(10), cm.rt_dia_productivo, 111) = '${diaProductivo}'
      AND hp.id_actividad = 2 -- Producción
      GROUP BY cm.Rt_Rendimientonominal1 -- Agrupar para agregar correctamente
    `;
        const result = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql, undefined, 'mapex');
        if (result.length === 0 || !result[0]) {
            return null;
        }
        const row = result[0];
        const disponibilidad = Math.max(0, Math.min(100, row.disponibilidad || 0));
        const rendimiento = Math.max(0, Math.min(100, row.rendimiento || 0));
        const calidad = Math.max(0, Math.min(100, row.calidad || 0));
        const oee = Math.round(disponibilidad * rendimiento * calidad / 10000);
        return {
            oee,
            rendimiento,
            disponibilidad,
            calidad
        };
    } catch (error) {
        console.error('❌ Erro ao calcular OEE para turno:', error);
        return null;
    }
}
async function getProductionDataForOF(machineCode, codOF) {
    try {
        const sql = `
      SELECT
        SUM(hp.unidades_ok) as total_ok,
        SUM(hp.unidades_nok) as total_nok,
        SUM(hp.unidades_repro) as total_rw,
        SUM(CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT)) as tiempo_produccion_segundos,
        MIN(hp.fecha_ini) as fecha_inicio_real,
        MAX(hp.fecha_fin) as fecha_fin_real
      FROM his_prod hp
      INNER JOIN his_fase hf ON hp.id_his_fase = hf.id_his_fase
      INNER JOIN his_of ho ON hf.id_his_of = ho.id_his_of
      WHERE ho.cod_of = '${codOF}'
      AND hp.id_actividad = 2 -- Producción
    `;
        const result = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql, undefined, 'mapex');
        if (result.length === 0 || !result[0]) {
            return null;
        }
        return result[0];
    } catch (error) {
        console.error('❌ Erro ao obter dados de produção:', error);
        return null;
    }
}
function calculateRemainingTime(remainingPieces, velocity) {
    if (velocity > 0 && remainingPieces > 0) {
        const remainingHours = remainingPieces / velocity;
        if (remainingHours >= 24) {
            return `${Math.round(remainingHours / 24)}d`;
        } else {
            return `${remainingHours.toFixed(1)}h`;
        }
    }
    return 'N/A';
}
function calculateProgress(totalProduced, plannedUnits) {
    if (plannedUnits > 0) {
        return Math.round(totalProduced / plannedUnits * 100);
    }
    return 0;
}
async function calcularOEE(machineCode, startDate, endDate) {
    return calculateOEEForOF(machineCode, '', 30); // Simplificado
}
async function calcularOEEPonderado(machineCode, startDate, endDate) {
    const oee = await calculateOEEForOF(machineCode, '', 30);
    return oee?.oee || 0;
}
async function generarAlertas(machineCode) {
    try {
        const oee = await calculateOEEForOF(machineCode, '', 1);
        const alerts = [];
        if (oee) {
            if (oee.oee < 60) {
                alerts.push({
                    type: 'danger',
                    message: 'OEE crítico: abaixo de 60%',
                    value: oee.oee
                });
            } else if (oee.oee < 75) {
                alerts.push({
                    type: 'warning',
                    message: 'OEE baixo: abaixo de 75%',
                    value: oee.oee
                });
            }
            if (oee.disponibilidad < 80) {
                alerts.push({
                    type: 'warning',
                    message: 'Disponibilidade baixa',
                    value: oee.disponibilidad
                });
            }
            if (oee.calidad < 95) {
                alerts.push({
                    type: 'warning',
                    message: 'Qualidade baixa',
                    value: oee.calidad
                });
            }
        }
        return alerts;
    } catch (error) {
        console.error('Erro ao gerar alertas:', error);
        return [];
    }
}
async function analizarParetoCausas(machineCode, startDate, endDate) {
    try {
        const sql = `
      SELECT
        cp.desc_paro as causa,
        SUM(DATEDIFF(MINUTE, hpp.fecha_ini, hpp.fecha_fin)) as tiempo_total_minutos,
        COUNT(*) as cantidad_paros
      FROM his_prod hp
      INNER JOIN his_prod_paro hpp ON hp.id_his_prod = hpp.id_his_prod
      INNER JOIN cfg_paro cp ON hpp.id_paro = cp.id_paro
      INNER JOIN cfg_maquina cm ON hp.id_maquina = cm.id_maquina
      WHERE cm.Cod_maquina = '${machineCode}'
      AND hpp.fecha_ini >= '${startDate.toISOString()}'
      AND hpp.fecha_ini <= '${endDate.toISOString()}'
      GROUP BY cp.desc_paro
      ORDER BY tiempo_total_minutos DESC
    `;
        const result = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql, undefined, 'mapex');
        // Calcular percentual cumulativo (Pareto 80/20)
        const totalTiempo = result.reduce((sum, item)=>sum + (item.tiempo_total_minutos || 0), 0);
        let tiempoAcumulado = 0;
        return result.map((item)=>{
            tiempoAcumulado += item.tiempo_total_minutos || 0;
            return {
                causa: item.causa || 'Sin causa',
                tiempo_total_minutos: item.tiempo_total_minutos || 0,
                cantidad_paros: item.cantidad_paros || 0,
                porcentaje: totalTiempo > 0 ? Math.round(item.tiempo_total_minutos / totalTiempo * 100) : 0,
                porcentaje_acumulado: totalTiempo > 0 ? Math.round(tiempoAcumulado / totalTiempo * 100) : 0
            };
        });
    } catch (error) {
        console.error('Erro ao analisar Pareto de causas:', error);
        return [];
    }
}
}),
"[project]/Downloads/mrpii 2/src/app/api/scada/machine-details/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Downloads/mrpii 2/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Downloads/mrpii 2/lib/database/connection.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$oee$2f$calculations$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Downloads/mrpii 2/lib/oee/calculations.ts [app-route] (ecmascript)");
;
;
;
async function POST(request) {
    try {
        const { machineId, tab } = await request.json();
        if (!machineId || !tab) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: 'Parâmetros machineId e tab são obrigatórios'
            }, {
                status: 400
            });
        }
        let data;
        switch(tab){
            case 'of':
                data = await getOFData(machineId);
                break;
            case 'paros':
                data = await getParosData(machineId);
                break;
            case 'produccion':
                data = await getProduccionData(machineId);
                break;
            case 'oee':
                data = await getOEEData(machineId);
                break;
            case 'pedidos':
                data = await getPedidosData(machineId);
                break;
            case 'historico':
                data = await getHistoricoData(machineId);
                break;
            case 'ventas':
                data = await getVentasData(machineId);
                break;
            default:
                return __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    success: false,
                    error: 'Tab não válida'
                }, {
                    status: 400
                });
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: true,
            data,
            tab,
            machineId,
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        console.error('❌ Erro ao buscar detalhes da máquina:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: false,
            error: 'Erro interno do servidor',
            message: error instanceof Error ? error.message : 'Erro desconhecido'
        }, {
            status: 500
        });
    }
}
async function getOFData(machineId) {
    try {
        // Obtener información básica de la máquina y OF
        const sql = `
      SELECT
        cm.Rt_Cod_of, cm.rt_Cod_producto, cm.Rt_Desc_producto,
        cm.Rt_Unidades_planning, cm.rt_dia_productivo, cm.rt_desc_turno,
        cm.Rt_Unidades_ok_of as Unidades_ok, cm.Rt_Unidades_nok_of as Rt_Unidades_nok, cm.Rt_Unidades_repro_of as Unidades_rw,
        cm.f_velocidad, cm.rt_id_his_fase, cm.rt_Desc_operario,
        ho.fecha_ini, ho.fecha_fin as fecha_fin_prevista, ho.id_his_of
      FROM cfg_maquina cm
      LEFT JOIN his_of ho ON cm.Rt_Cod_of = ho.cod_of
      WHERE cm.Cod_maquina = '${machineId}'
    `;
        const result = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql, undefined, 'mapex');
        if (result.length === 0) return null;
        const row = result[0];
        const cod_of = row.Rt_Cod_of;
        const id_his_of = row.id_his_of;
        // Obtener datos OEE para la OF usando nossa função simulada
        let oee_data = null;
        try {
            oee_data = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$oee$2f$calculations$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["calculateOEEForOF"])(machineId, cod_of);
        } catch (error) {
            console.warn('⚠️ Erro ao calcular OEE para OF:', error);
        }
        // Obtener datos de producción detallados
        let produccion_data = null;
        if (id_his_of) {
            const sql_produccion = `
        SELECT
          SUM(hp.unidades_ok) as total_ok,
          SUM(hp.unidades_nok) as total_nok,
          SUM(hp.unidades_repro) as total_rw,
          SUM(CAST(DATEDIFF(SECOND, hp.fecha_ini, hp.fecha_fin) AS BIGINT)) as tiempo_produccion_segundos,
          MIN(hp.fecha_ini) as fecha_inicio_real,
          MAX(hp.fecha_fin) as fecha_fin_real
        FROM his_prod hp
        INNER JOIN his_fase hf ON hp.id_his_fase = hf.id_his_fase
        WHERE hf.id_his_of = '${id_his_of}'
        AND hp.id_actividad = 2
      `;
            const produccion_result = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql_produccion, undefined, 'mapex');
            produccion_data = produccion_result[0] || null;
        }
        // Obtener datos de paros para esta OF
        let paros_data = null;
        if (id_his_of) {
            const sql_paros = `
        SELECT
          SUM(CAST(DATEDIFF(SECOND, hpp.fecha_ini, hpp.fecha_fin) AS BIGINT)) as tiempo_paros_segundos,
          COUNT(DISTINCT hpp.Id_operario) as num_operarios
        FROM his_prod hp
        INNER JOIN his_prod_paro hpp ON hp.id_his_prod = hpp.id_his_prod
        INNER JOIN his_fase hf ON hp.id_his_fase = hf.id_his_fase
        WHERE hf.id_his_of = '${id_his_of}'
      `;
            const paros_result = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql_paros, undefined, 'mapex');
            paros_data = paros_result[0] || null;
        }
        // Obtener los principales paros
        let principales_paros = [];
        if (id_his_of) {
            const sql_principales_paros = `
        SELECT
          cp.desc_paro,
          SUM(CAST(DATEDIFF(SECOND, hpp.fecha_ini, hpp.fecha_fin) AS BIGINT)) as tiempo_segundos
        FROM his_prod hp
        INNER JOIN his_prod_paro hpp ON hp.id_his_prod = hpp.id_his_prod
        INNER JOIN cfg_paro cp ON hpp.id_paro = cp.id_paro
        INNER JOIN his_fase hf ON hp.id_his_fase = hf.id_his_fase
        WHERE hf.id_his_of = '${id_his_of}'
        GROUP BY cp.desc_paro
        ORDER BY tiempo_segundos DESC
      `;
            principales_paros = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql_principales_paros, undefined, 'mapex');
        }
        // Obtener datos para gráfico de producción por turno
        let produccion_turno = [];
        if (id_his_of) {
            const sql_produccion_turno = `
        SELECT
          cm.rt_desc_turno as turno,
          CONVERT(VARCHAR(10), hp.fecha_fin, 111) as fecha,
          SUM(hp.unidades_ok) as unidades_ok,
          SUM(hp.unidades_nok) as unidades_nok,
          SUM(hp.unidades_repro) as unidades_rw
        FROM his_prod hp
        INNER JOIN cfg_maquina cm ON hp.Id_maquina = cm.id_maquina
        INNER JOIN his_fase hf ON hp.id_his_fase = hf.id_his_fase
        WHERE hf.id_his_of = '${id_his_of}'
        AND cm.Cod_maquina = '${machineId}'
        GROUP BY cm.rt_desc_turno, CONVERT(VARCHAR(10), hp.fecha_fin, 111)
        ORDER BY fecha, turno
      `;
            produccion_turno = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql_produccion_turno, undefined, 'mapex');
        }
        // Calcular métricas derivadas
        const total_produced = produccion_data ? (produccion_data.total_ok || 0) + (produccion_data.total_nok || 0) + (produccion_data.total_rw || 0) : (row.Unidades_ok || 0) + (row.Rt_Unidades_nok || 0) + (row.Unidades_rw || 0);
        const avance = row.Rt_Unidades_planning > 0 ? Math.round(total_produced / row.Rt_Unidades_planning * 10000) / 100 : 0;
        const remaining_pieces = row.Rt_Unidades_planning - total_produced;
        const remaining_time = (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$oee$2f$calculations$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["calculateRemainingTime"])(remaining_pieces, row.f_velocidad || 0);
        // Calcular desviación (calidad)
        const desviacion = total_produced > 0 ? Math.round((row.Rt_Unidades_nok || 0) / total_produced * 10000) / 100 : 0;
        return {
            // Información básica
            ...row,
            cod_of,
            id_his_of,
            // Métricas calculadas
            total_produced,
            avance_porcentaje: avance,
            remaining_pieces,
            remaining_time,
            desviacion_porcentaje: desviacion,
            // Datos OEE
            oee_data,
            // Datos de producción detallados
            produccion_data,
            // Datos de paros
            paros_data,
            principales_paros,
            // Datos para gráficos
            produccion_turno,
            // Información adicional para UI
            status: {
                avance_class: avance >= 90 ? 'success' : avance >= 70 ? 'warning' : 'danger',
                tiempo_class: remaining_pieces > 0 && row.f_velocidad > 0 ? remaining_pieces / row.f_velocidad > 24 ? 'warning' : 'success' : 'info',
                desviacion_class: desviacion > 5 ? 'danger' : 'success'
            }
        };
    } catch (error) {
        console.error('❌ Erro ao obter dados OF:', error);
        return null;
    }
}
async function getParosData(machineId) {
    try {
        // Obtener la OF actual de la máquina
        const sql_of_actual = `SELECT Rt_Cod_of FROM cfg_maquina WHERE Cod_maquina = '${machineId}'`;
        const result_of_actual = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql_of_actual, undefined, 'mapex');
        const of_actual = result_of_actual[0]?.Rt_Cod_of || '';
        // Obtener tipos de paro para el filtro
        const sql_tipos_paro = `SELECT DISTINCT id_paro, desc_paro FROM cfg_paro ORDER BY desc_paro`;
        const tipos_paro = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql_tipos_paro, undefined, 'mapex');
        // Obtener lista de OFs para el filtro (últimos 7 días por defecto)
        const sql_ofs = `
      SELECT DISTINCT substring(hof.cod_of, 1, 15) as cod_of, hof.fecha_ini
      FROM his_prod hp
      INNER JOIN his_fase hf ON hp.id_his_fase = hf.id_his_fase
      INNER JOIN his_of hof ON hf.id_his_of = hof.id_his_of
      INNER JOIN cfg_maquina cm ON hp.id_maquina = cm.id_maquina
      WHERE cm.Cod_maquina = '${machineId}'
      AND hof.fecha_ini >= DATEADD(day, -7, GETDATE())
      ORDER BY hof.fecha_ini DESC
    `;
        const ofs = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql_ofs, undefined, 'mapex');
        // Obtener paros con filtros (últimos 30 días por defecto)
        const sql_paros = `
      SELECT
        hpp.fecha_ini,
        hpp.fecha_fin,
        DATEDIFF(MINUTE, hpp.fecha_ini, hpp.fecha_fin) as duracion_minutos,
        cp.id_paro,
        cp.desc_paro,
        substring(hof.cod_of, 1, 15) as cod_of,
        hpp.Id_operario,
        COALESCE(hpo.observaciones, '') as observaciones
      FROM his_prod hp
      INNER JOIN his_prod_paro hpp ON hp.id_his_prod = hpp.id_his_prod
      INNER JOIN cfg_paro cp ON hpp.id_paro = cp.id_paro
      INNER JOIN cfg_maquina cm ON hp.id_maquina = cm.id_maquina
      INNER JOIN his_fase hf ON hp.id_his_fase = hf.id_his_fase
      INNER JOIN his_of hof ON hf.id_his_of = hof.id_his_of
      LEFT JOIN his_paro_obs hpo ON hpo.his_paro = hpp.his_paro
      WHERE cm.Cod_maquina = '${machineId}'
      AND hpp.fecha_ini >= DATEADD(day, -30, GETDATE())
      ORDER BY hpp.fecha_ini DESC
    `;
        const paros = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql_paros, undefined, 'mapex');
        // Calcular estadísticas de paros
        const total_paros = paros.length;
        const total_minutos = paros.reduce((sum, p)=>sum + (p.duracion_minutos || 0), 0);
        // Agrupar paros por tipo
        const paros_por_tipo = {};
        paros.forEach((paro)=>{
            const tipo = paro.desc_paro || 'Sin tipo';
            if (!paros_por_tipo[tipo]) {
                paros_por_tipo[tipo] = {
                    count: 0,
                    minutos: 0
                };
            }
            paros_por_tipo[tipo].count++;
            paros_por_tipo[tipo].minutos += paro.duracion_minutos || 0;
        });
        return {
            paros,
            estadisticas: {
                total_paros,
                total_minutos,
                promedio_minutos: total_paros > 0 ? Math.round(total_minutos / total_paros) : 0
            },
            paros_por_tipo: Object.entries(paros_por_tipo).map(([tipo, data])=>({
                    tipo,
                    count: data.count,
                    minutos: data.minutos,
                    porcentaje: total_paros > 0 ? Math.round(data.count / total_paros * 100) : 0
                })),
            filtros: {
                of_actual,
                tipos_paro,
                ofs,
                fecha_desde: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                fecha_hasta: new Date().toISOString().split('T')[0]
            }
        };
    } catch (error) {
        console.error('❌ Erro ao obter dados de paros:', error);
        return {
            paros: [],
            estadisticas: {
                total_paros: 0,
                total_minutos: 0,
                promedio_minutos: 0
            },
            paros_por_tipo: [],
            filtros: {
                of_actual: '',
                tipos_paro: [],
                ofs: [],
                fecha_desde: '',
                fecha_hasta: ''
            }
        };
    }
}
async function getProduccionData(machineId) {
    const sql = `
    SELECT TOP 20
      hp.fecha, hp.turno, hp.unidades_ok, hp.unidades_nok, hp.unidades_rw,
      hp.tiempo_produccion, hp.velocidad_media, hp.nom_operario
    FROM his_prod hp
    INNER JOIN cfg_maquina cm ON hp.id_maquina = cm.id_maquina
    WHERE cm.Cod_maquina = '${machineId}'
      AND hp.fecha >= DATEADD(day, -30, GETDATE())
    ORDER BY hp.fecha DESC, hp.turno DESC
  `;
    try {
        return await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql, undefined, 'mapex');
    } catch (error) {
        console.warn('⚠️ Error al obtener datos - retornando datos vacíos');
        return [];
    }
}
async function getOEEData(machineId) {
    const sql = `
    SELECT TOP 10
      fecha, turno,
      disponibilidad, rendimiento, calidad, oee,
      tiempo_planificado, tiempo_operativo, piezas_objetivo
    FROM F_his_ct
    WHERE id_maquina = (SELECT id_maquina FROM cfg_maquina WHERE Cod_maquina = '${machineId}')
      AND fecha >= DATEADD(day, -30, GETDATE())
    ORDER BY fecha DESC, turno DESC
  `;
    try {
        return await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql, undefined, 'mapex');
    } catch (error) {
        console.warn('⚠️ Error al obtener datos - retornando datos vacíos');
        return [];
    }
}
async function getPedidosData(machineId) {
    try {
        const sql = `
      SELECT TOP 20
        p.cod_pedido, p.desc_producto, p.cantidad_pedido, p.cantidad_entregada,
        p.fecha_pedido, p.fecha_entrega_prevista, p.estado_pedido
      FROM pedidos p
      INNER JOIN cfg_maquina cm ON p.id_maquina = cm.id_maquina
      WHERE cm.Cod_maquina = '${machineId}'
        AND p.fecha_pedido >= DATEADD(day, -60, GETDATE())
      ORDER BY p.fecha_pedido DESC
    `;
        return await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql, undefined, 'sage');
    } catch (error) {
        console.warn('⚠️ Banco SAGE não disponível para pedidos - retornando dados vazios');
        return [];
    }
}
async function getHistoricoData(machineId) {
    const sql = `
    SELECT
      CAST(hp.fecha AS DATE) as fecha,
      SUM(hp.unidades_ok) as total_ok,
      SUM(hp.unidades_nok) as total_nok,
      SUM(hp.unidades_rw) as total_rw,
      AVG(CASE WHEN hp.unidades_ok + hp.unidades_nok + hp.unidades_rw > 0
               THEN (hp.unidades_ok * 100.0) / (hp.unidades_ok + hp.unidades_nok + hp.unidades_rw)
               ELSE 0 END) as eficiencia_diaria
    FROM his_prod hp
    INNER JOIN cfg_maquina cm ON hp.id_maquina = cm.id_maquina
    WHERE cm.Cod_maquina = '${machineId}'
      AND hp.fecha >= DATEADD(day, -90, GETDATE())
    GROUP BY CAST(hp.fecha AS DATE)
    ORDER BY fecha DESC
  `;
    try {
        return await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql, undefined, 'mapex');
    } catch (error) {
        console.warn('⚠️ Error al obtener datos - retornando datos vacíos');
        return [];
    }
}
async function getVentasData(machineId) {
    try {
        const sql = `
      SELECT TOP 20
        v.cod_venta, v.cliente, v.producto, v.cantidad, v.valor_venta,
        v.fecha_venta, v.estado_entrega
      FROM ventas v
      INNER JOIN cfg_maquina cm ON v.id_maquina = cm.id_maquina
      WHERE cm.Cod_maquina = '${machineId}'
        AND v.fecha_venta >= DATEADD(day, -90, GETDATE())
      ORDER BY v.fecha_venta DESC
    `;
        return await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Downloads$2f$mrpii__2$2f$lib$2f$database$2f$connection$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["executeQuery"])(sql, undefined, 'sage');
    } catch (error) {
        console.warn('⚠️ Banco SAGE não disponível para vendas - retornando dados vazios');
        return [];
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__d10edd96._.js.map