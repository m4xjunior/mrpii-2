module.exports=[3930,e=>{"use strict";e.s(["handler",()=>_,"patchFetch",()=>A,"routeModule",()=>D,"serverHooks",()=>w,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>v],3930);var t=e.i(74353),a=e.i(19310),r=e.i(20050),o=e.i(32930),n=e.i(49260),s=e.i(25482),i=e.i(36688),l=e.i(23026),c=e.i(1251),d=e.i(6621),u=e.i(93265),p=e.i(72116),h=e.i(61195),R=e.i(99119),m=e.i(93695);e.i(4079);var E=e.i(55985);e.s(["GET",()=>C],33496);var g=e.i(12415),f=e.i(50619),O=e.i(37591);async function C(e){try{let t=e.nextUrl.searchParams,a=t.get("machineId")||null,r=parseInt(t.get("days")||"30");console.log(`📊 Buscando datos hist\xf3ricos - M\xe1quina: ${a}, D\xedas: ${r}`);let o=await (0,O.getAllProductCosts)(),n=Object.keys(o).length>0?Object.values(o).reduce((e,t)=>e+t,0)/Object.keys(o).length:15.5;console.log("💰 Costo promedio para cálculos históricos:",{totalProductos:Object.keys(o).length,costoPromedio:n,nota:"Usado para calcular costos de scrap en consultas SQL"});let s=[],i=[];try{await (0,f.executeQuery)("SELECT TOP 1 'OK' as status, GETDATE() as fecha",void 0,"mapex"),console.log("✅ Conexión MAPEX OK");let e=`
        SELECT TOP 10
          CONVERT(VARCHAR(10), hp.fecha, 120) as fecha,
          cm.Cod_maquina,
          COUNT(*) as registros
        FROM his_prod hp
        INNER JOIN cfg_maquina cm ON hp.id_maquina = cm.id_maquina
        WHERE hp.fecha >= DATEADD(day, -${r}, GETDATE())
          AND cm.activo = 1
          ${a?`AND cm.Cod_maquina = '${a}'`:""}
        GROUP BY CONVERT(VARCHAR(10), hp.fecha, 120), cm.Cod_maquina
        ORDER BY fecha DESC
      `;s=await (0,f.executeQuery)(e,void 0,"mapex"),console.log(`📊 Datos de producci\xf3n: ${s.length} registros`)}catch(t){let e=t instanceof Error?t.message:String(t);console.warn("⚠️ Error al buscar datos de producción:",e),console.warn("⚠️ Usando datos simulados para producción"),s=function(e,t){let a=[],r=t?[t]:["DOBL01","DOBL02","SOLD01","SOLD02","TROQ01","TERM01"];for(let t=e;t>=0;t--){let e=new Date;e.setDate(e.getDate()-t),r.forEach(t=>{a.push({fecha:e.toISOString().split("T")[0],Cod_maquina:t,registros:Math.floor(50*Math.random())+10})})}return a}(r,a)}try{let e=`
        SELECT TOP 10
          CONVERT(VARCHAR(10), hpp.fecha_inicio, 120) as fecha,
          cm.Cod_maquina,
          COUNT(*) as num_paros
        FROM his_prod_paro hpp
        INNER JOIN his_prod hp ON hpp.id_his_prod = hp.id_his_prod
        INNER JOIN cfg_maquina cm ON hp.id_maquina = cm.id_maquina
        WHERE hpp.fecha_inicio >= DATEADD(day, -${r}, GETDATE())
          AND cm.activo = 1
          ${a?`AND cm.Cod_maquina = '${a}'`:""}
        GROUP BY CONVERT(VARCHAR(10), hpp.fecha_inicio, 120), cm.Cod_maquina
        ORDER BY fecha DESC
      `;i=await (0,f.executeQuery)(e,void 0,"mapex"),console.log(`📊 Datos de paros: ${i.length} registros`)}catch(t){let e=t instanceof Error?t.message:String(t);console.warn("⚠️ Error al buscar datos de paros:",e),console.warn("⚠️ Usando datos simulados para paros"),i=function(e,t){let a=[],r=t?[t]:["DOBL01","DOBL02","SOLD01","SOLD02","TROQ01","TERM01"];for(let t=e;t>=0;t--){let e=new Date;e.setDate(e.getDate()-t),r.forEach(t=>{.3>Math.random()&&a.push({fecha:e.toISOString().split("T")[0],Cod_maquina:t,num_paros:Math.floor(3*Math.random())+1})})}return a}(r,a)}let l=[];if(s.length>0){let e=s.reduce((e,t)=>e+(t.registros||0),0);l.push({tipo:"PRODUCCION_RESUMEN",mensaje:`Total registros de producci\xf3n: ${e} en ${s.length} d\xedas`,prioridad:"INFO"})}if(i.length>0){let e=i.reduce((e,t)=>e+(t.num_paros||0),0);l.push({tipo:"PAROS_RESUMEN",mensaje:`Total paros registrados: ${e} en ${i.length} d\xedas`,prioridad:"INFO"})}return g.NextResponse.json({success:!0,data:{production:s,downtime:i,insights:l,filters:{machineId:a,days:r,dateRange:{from:new Date(Date.now()-24*r*36e5).toISOString().split("T")[0],to:new Date().toISOString().split("T")[0]}}},timestamp:new Date().toISOString()})}catch(e){return console.error("❌ Error en datos históricos:",e),g.NextResponse.json({success:!1,error:"Error al obtener datos históricos",message:e instanceof Error?e.message:"Error desconocido"},{status:500})}}var T=e.i(33496);let D=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/analytics/historical/route",pathname:"/api/analytics/historical",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/Downloads/mrpii 2/src/app/api/analytics/historical/route.ts",nextConfigOutput:"",userland:T}),{workAsyncStorage:N,workUnitAsyncStorage:v,serverHooks:w}=D;function A(){return(0,r.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:v})}async function _(e,t,r){var g;let f="/api/analytics/historical/route";f=f.replace(/\/index$/,"")||"/";let O=await D.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!O)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:C,params:T,nextConfig:N,isDraftMode:v,prerenderManifest:w,routerServerContext:A,isOnDemandRevalidate:_,revalidateOnlyGenerated:x,resolvedPathname:S}=O,y=(0,s.normalizeAppPath)(f),P=!!(w.dynamicRoutes[y]||w.routes[S]);if(P&&!v){let e=!!w.routes[S],t=w.dynamicRoutes[y];if(t&&!1===t.fallback&&!e)throw new m.NoFallbackError}let I=null;!P||D.isDev||v||(I="/index"===(I=S)?"/":I);let q=!0===D.isDev||!P,M=P&&!q,U=e.method||"GET",b=(0,n.getTracer)(),H=b.getActiveScopeSpan(),$={params:T,prerenderManifest:w,renderOpts:{experimental:{cacheComponents:!!N.experimental.cacheComponents,authInterrupts:!!N.experimental.authInterrupts},supportsDynamicResponse:q,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(g=N.experimental)?void 0:g.cacheLife,isRevalidate:M,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>D.onRequestError(e,t,r,A)},sharedContext:{buildId:C}},L=new i.NodeNextRequest(e),k=new i.NodeNextResponse(t),j=l.NextRequestAdapter.fromNodeNextRequest(L,(0,l.signalFromNodeResponse)(t));try{let s=async a=>D.handle(j,$).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=b.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=r.get("next.route");if(o){let e=`${U} ${o}`;a.setAttributes({"next.route":o,"http.route":o,"next.span_name":e}),a.updateName(e)}else a.updateName(`${U} ${e.url}`)}),i=async n=>{var i,l;let c=async({previousCacheEntry:a})=>{try{if(!(0,o.getRequestMeta)(e,"minimalMode")&&_&&x&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let c=$.renderOpts.collectedTags;if(!P)return await (0,u.sendResponse)(L,k,i,$.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[R.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,r=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isRevalidate:M,isOnDemandRevalidate:_})},A),t}},m=await D.handleResponse({req:e,nextConfig:N,cacheKey:I,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:w,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:x,responseGenerator:c,waitUntil:r.waitUntil});if(!P)return null;if((null==m||null==(i=m.value)?void 0:i.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==m||null==(l=m.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,o.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",_?"REVALIDATED":m.isMiss?"MISS":m.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,p.fromNodeOutgoingHttpHeaders)(m.value.headers);return(0,o.getRequestMeta)(e,"minimalMode")&&P||g.delete(R.NEXT_CACHE_TAGS_HEADER),!m.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,h.getCacheControlHeader)(m.cacheControl)),await (0,u.sendResponse)(L,k,new Response(m.value.body,{headers:g,status:m.value.status||200})),null};H?await i(H):await b.withPropagatedContext(e.headers,()=>b.trace(c.BaseServerSpan.handleRequest,{spanName:`${U} ${e.url}`,kind:n.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},i))}catch(t){if(H||t instanceof m.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isRevalidate:M,isOnDemandRevalidate:_})}),P)throw t;return await (0,u.sendResponse)(L,k,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=e75cc_next_dist_esm_build_templates_app-route_ecc7b999.js.map